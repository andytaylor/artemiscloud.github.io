---
title: "Using the custom init image"  
type: "featured"
description: "Introduction to the opterator custom init image"
draft: false
---

Starting from [v0.18.1](https://github.com/artemiscloud/activemq-artemis-operator/tree/v0.18.1) the ActiveMQ Artemis Operator introduces a new feature called **custom init image** that allows users to do their own configuration of brokers within the operator framework.

## What is Custom Init Image
The custom init image is a user provided docker image that can be configured in the ActiveMQ Artemis broker custom resource file (CR). When the CR is deployed the ActiveMQ Artemis operator will search and run the post-configure script (if that exists in the custom init image) so that it can modify the broker instance pre-configured by the operator before the pod is started.

## How it works
The ActiveMQ Artemis operator works with the broker's [CustomResourceDefinition(CRD)](https://github.com/artemiscloud/activemq-artemis-operator/blob/v0.18.1/deploy/crds/broker_activemqartemis_crd.yaml) that defines a set of parameters to configure brokers through the operator. For example user can define address settings in the [CR file](https://github.com/artemiscloud/activemq-artemis-operator/blob/v0.18.1/deploy/examples/artemis-basic-address-settings-deployment.yaml) and deploy it into the cluster. However the broker CRD doesn't cover every respects of a broker configuration. When a user needs to configure the broker that not available in the CRD, they have to find some homemade ways to so it. For example using S2I directly with the broker container image.

Internally the ActiveMQ Artemis operator uses an init container to configure each broker instance. If no custom init image is specified it uses the [built-in init image](https://quay.io/repository/artemiscloud/activemq-artemis-broker-init) which is responsible for the actual configuration. Once done the broker configuration is passed to the [broker container image](https://quay.io/repository/artemiscloud/activemq-artemis-broker-kubernetes) to launch the broker with it.

If a custom init image is specified in the CR, the operator installs it in place of the built-in init image. First the operator use this custom image as a built-in image to perform the configuration mentioned above, then it calls the post-config.sh script in the custom init image to start user provided custom configuration on top of the one produced by the built-in init image. The operator exposes the broker configuration instance location to the custom init image via a environment variable **CONFIG_INSTANCE_DIR**. In this location is a typical broker instance dir, whose structure is like

<a name="instancedir"></a>
```
${CONFIG_INSTANCE_DIR}
  |
  \--/bin
  \--/etc
  \--/data
  \--/lib
  \--/log
  \--/tmp
```
By the time the custom init image's post-config.sh is invoked the **CONFIG_INSTANCE_DIR** already contains all the configuration files generated by the built-in image (i.e. configurations from CR) and available for the custom init image's post-config.sh script to do extra configuration.

It can for example modify the logging settings and add/override some specific configurations in **${CONFIG_INSTANCE_DIR}/etc**. And if needed it can put extra runtime dependencies (jar files) to **${CONFIG_INSTANCE_DIR}/lib** so that the broker can load them into classpath.

After the post-config.sh is returned, the broker instance will be launched with the updated configuration.

## Adding a custom init image
First you need to implement your custom init image.

The custom init image shall follow the predefined rules:

* The custom init image must take ActiveMQ Artemis operator's [built-in init image](https://quay.io/repository/artemiscloud/activemq-artemis-broker-init) as its base image in its docker file, for example

  (Dockerfile):
```
   FROM quay.io/artemiscloud/activemq-artemis-broker-init:0.2.3
   ...
```

* The custom init image must put a post-config.sh script inside the image in the directory **/amq/scripts**. The absolute path therefore is **/amq/scripts/post-config.sh**.

 You need to prepare a **post-config.sh** script where you put in actions that does your custom configuration with the broker [instance](#instancedir).

If you need additional resources (xmls, jars, etc) for your custom configuration you need to add them to your image and make sure they are accessible for your post-config scripts.

Then you need to build it into a docker image and put it into a public container repository (for example you can create a repository on quay.io).

Edit your CR file and add the your custom init image. For example:
```
apiVersion: broker.amq.io/v2alpha4
kind: ActiveMQArtemis
metadata:
  name: ex-aao
spec:
  deploymentPlan:
    size: 1
    image: quay.io/artemiscloud/activemq-artemis-broker-kubernetes:0.2.1
    initImage: <your_custom_init_image_url>
 ...
```
Finally deply the CR file.

## Further information
* A fully working example is available [here](https://github.com/artemiscloud/artemiscloud-examples/tree/main/operator/init/jdbc)

* For issues/suggestions please raise it on [artemiscloud](https://github.com/artemiscloud/activemq-artemis-operator/issues)
