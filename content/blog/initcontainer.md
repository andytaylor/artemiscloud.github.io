---
title: "Using the custom init image"  
type: "regular"
description: "Introduction to the operator custom init image"
draft: false
---

Starting from [v0.18.1](https://github.com/artemiscloud/activemq-artemis-operator/tree/v0.18.1) the ActiveMQ Artemis Operator 
introduces a new feature, **custom init image**, that allows users to do their own configuration of brokers within the operator framework.

### What is a Custom Init Image
The ActiveMQ Artemis operator uses a [CustomResourceDefinition(CRD)](https://github.com/artemiscloud/activemq-artemis-operator/blob/v0.18.1/deploy/crds/broker_activemqartemis_crd.yaml) 
that defines a set of parameters to configure brokers through the operator for example a user can define address settings 
in the [CR file](https://github.com/artemiscloud/activemq-artemis-operator/blob/v0.18.1/deploy/examples/artemis-basic-address-settings-deployment.yaml). 

For configuration that isn't exposed in the CRD's the user can provide a custom init image to manipulate or add to the configuration
that has been created by the Operator. When the CR is deployed and the broker instance is created the operator will then
run a  user provided post configuration script.

### How it works
Internally the ActiveMQ Artemis operator uses an init container to configure each broker instance. If no custom init image 
is specified it uses the [built-in init image](https://quay.io/repository/artemiscloud/activemq-artemis-broker-init) which 
is responsible for the actual configuration. The broker configuration is then passed to the [broker container image](https://quay.io/repository/artemiscloud/activemq-artemis-broker-kubernetes) 
to launch the broker with it.

If a custom init image is provided and configured in the CR then this will be used to create the configuration. Since the custom
image is built on top of the ArtemisCloud init image it will firstly lay down the brokers configuration defined in the CR.
Post the creation of this configuration the Operator will execute the post-config.sh script provided by the custom init container.
For ease of use the environment variable **CONFIG_INSTANCE_DIR** is set which points to the broker instance dir which has the following structure.

<a name="instancedir"></a>
```
${CONFIG_INSTANCE_DIR}
  |
  \--/bin
  \--/etc
  \--/data
  \--/lib
  \--/log
  \--/tmp
```
By the time the custom init image's post-config.sh is invoked the **CONFIG_INSTANCE_DIR** already contains all the configuration 
files generated by the built-in image (i.e. configurations from CR) and available for the custom init image's post-config.sh 
script to do extra configuration.

It can for example modify the logging settings and add/override some specific configurations in **${CONFIG_INSTANCE_DIR}/etc** 
and if needed it can put extra runtime dependencies (jar files) in **${CONFIG_INSTANCE_DIR}/lib** so that the broker can 
use them

After the post-config.sh is executed, the broker instance will be launched with the updated configuration.

### Adding a custom init image
First you need to implement your custom init image.

The custom init image should follow the predefined rules:

* The custom init image must use the ActiveMQ Artemis operator's [built-in init image](https://quay.io/repository/artemiscloud/activemq-artemis-broker-init) 
as its base image in its docker file, for example

```
   FROM quay.io/artemiscloud/activemq-artemis-broker-init:0.2.3
   ...
```

* The custom init image must put a post-config.sh script inside the image in the directory **/amq/scripts**. The absolute 
path will be **/amq/scripts/post-config.sh**.

The **post-config.sh** script is where you modify the configuration of the broker or add any third party dependencies.

If you need additional resources (xmls, jars, etc) for your custom configuration you need to add them to your image and 
make sure they are accessible for your post-config scripts.

Next you need to build your init container image and put it into a container repository (for example you can create a repository on quay.io).

Lasty you need to configure the Operator to use the custom int container it by editing the CR file, For example:
```yaml
apiVersion: broker.amq.io/v2alpha4
kind: ActiveMQArtemis
metadata:
  name: ex-aao
spec:
  deploymentPlan:
    size: 1
    image: quay.io/artemiscloud/activemq-artemis-broker-kubernetes:0.2.1
    initImage: <your_custom_init_image_url>
 ...
```
Finally deploy the CR file in the usual manner, see [Getting Started with ActiveMQ Artemis Operator]({{< ref "using_operator" >}} "About Us") for more info

### Further information
* A fully working example is available [here](https://github.com/artemiscloud/artemiscloud-examples/tree/main/operator/init/jdbc)

* For issues/suggestions please raise issue at [artemiscloud](https://github.com/artemiscloud/activemq-artemis-operator/issues)
